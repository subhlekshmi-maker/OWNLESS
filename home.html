<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OWN/LESS - VIT Exchange</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <div class="header-logo-circle">
                    <svg class="header-logo-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"
                            fill="#9333ea" />
                    </svg>
                </div>
                <div class="header-brand">
                    <h1 class="header-brand-name">OWN/LESS</h1>
                    <p class="header-brand-subtitle">VIT Exchange</p>
                </div>
            </div>
            <nav class="header-nav">
                <a href="home.html" class="nav-item active">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 7V5C3 3.9 3.9 3 5 3H19C20.1 3 21 3.9 21 5V7" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M3 7L12 13L21 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M3 7V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V7" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span>Browse</span>
                </a>
                <a href="messages.html" class="nav-item">
                    <div class="nav-icon-wrapper">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <!-- <span class="badge">1</span> -->
                    </div>
                    <span>Messages</span>
                </a>
                <a href="profile.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                    <span>Profile</span>
                </a>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Welcome Banner -->
            <div class="welcome-banner">
                <div class="welcome-content">
                    <h2 class="welcome-title">Welcome back! ðŸ‘‹</h2>
                    <p class="welcome-subtitle">Borrow what you need, sell what you don't. It's that simple.</p>
                </div>
                <button class="list-item-btn" onclick="openListModal()">
                    <svg class="plus-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 5V19" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                    <span>List Item</span>
                </button>
            </div>

            <!-- Borrow/Sell/Lend Toggle -->
            <div class="action-toggle">
                <button class="toggle-btn active" data-view="borrow" onclick="switchView('borrow')">
                    Borrow
                </button>
                <button class="toggle-btn" data-view="sell" onclick="switchView('sell')">
                    Sell
                </button>
                <button class="toggle-btn" data-view="lend" onclick="switchView('lend')">
                    Lend
                </button>
            </div>

            <!-- Content Container -->
            <div class="content-wrapper">
                <!-- Borrow View -->
                <div class="content-section active" id="borrow-view">
                    <div class="items-grid" id="borrow-grid">
                    </div>
                </div>

                <!-- Sell View -->
                <div class="content-section" id="sell-view">
                    <div class="items-grid" id="sell-grid">
                    </div>
                </div>

                <!-- Lend View -->
                <div class="content-section" id="lend-view">
                    <div class="items-grid" id="lend-grid">
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- List Item Modal -->
    <div id="list-modal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <button class="modal-close" onclick="closeListModal()">x</button>

            <h2 class="modal-title">List Your Item</h2>

            <form class="list-item-form" id="list-item-form">
                <div class="form-section">
                    <label class="form-label">Listing Type</label>
                    <div class="listing-type-toggle">
                        <button type="button" class="listing-type-btn active" data-listing-type="lending"
                            onclick="switchListingType('lending')">Lending</button>
                        <button type="button" class="listing-type-btn" data-listing-type="selling"
                            onclick="switchListingType('selling')">Selling</button>
                        <button type="button" class="listing-type-btn" data-listing-type="buying"
                            onclick="switchListingType('buying')">Buying</button>
                    </div>
                </div>

                <div class="form-section">
                    <label class="form-label">Item Title</label>
                    <input type="text" class="form-input" id="item-title" required>
                </div>

                <div class="form-section">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="item-description" required></textarea>
                </div>

                <div class="form-section">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="item-category" required>
                        <option value="fashion">Fashion</option>
                        <option value="books">Books</option>
                        <option value="electronics">Electronics</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-section">
                    <label class="form-label">Item Image</label>
                    <div class="image-url-wrapper" style="display:flex; gap:10px; align-items:center;">
                        <input type="url" class="form-input" id="item-image-url" placeholder="Paste image URL..."
                            style="flex:1">
                        <span style="color:#aaa;">OR</span>
                        <input type="file" id="item-image-file" accept="image/*" style="color:#fff;">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-section">
                        <label class="form-label">Price (â‚¹)</label>
                        <input type="number" class="form-input" id="item-price" value="0" required>
                    </div>
                </div>

                <div class="form-buttons">
                    <button type="button" class="cancel-btn" onclick="closeListModal()">Cancel</button>
                    <button type="submit" class="submit-btn">List Item</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function switchView(view) {
            const borrowBtn = document.querySelector('[data-view="borrow"]');
            const sellBtn = document.querySelector('[data-view="sell"]');
            const lendBtn = document.querySelector('[data-view="lend"]');
            const borrowView = document.getElementById('borrow-view');
            const sellView = document.getElementById('sell-view');
            const lendView = document.getElementById('lend-view');

            [borrowBtn, sellBtn, lendBtn].forEach(btn => btn.classList.remove('active'));
            [borrowView, sellView, lendView].forEach(view => view.classList.remove('active'));

            if (view === 'borrow') {
                borrowBtn.classList.add('active');
                borrowView.classList.add('active');
            } else if (view === 'sell') {
                sellBtn.classList.add('active');
                sellView.classList.add('active');
            } else if (view === 'lend') {
                lendBtn.classList.add('active');
                lendView.classList.add('active');
            }
        }

        function openListModal() {
            document.getElementById('list-modal').style.display = 'flex';
        }

        function closeListModal() {
            document.getElementById('list-modal').style.display = 'none';
        }

        function switchListingType(type) {
            const lendBtn = document.querySelector('[data-listing-type="lending"]');
            const sellBtn = document.querySelector('[data-listing-type="selling"]');
            const buyBtn = document.querySelector('[data-listing-type="buying"]');

            [lendBtn, sellBtn, buyBtn].forEach(btn => btn.classList.remove('active'));

            if (type === 'lending') lendBtn.classList.add('active');
            else if (type === 'selling') sellBtn.classList.add('active');
            else if (type === 'buying') buyBtn.classList.add('active');
        }

        window.onclick = function (event) {
            const modal = document.getElementById('list-modal');
            if (event.target === modal) closeListModal();
        }
    </script>

    <script type="module">
        import { requireAuth, getCurrentUser } from "./src/auth.js";
        import { addItem, loadItems, uploadImage } from "./src/items.js";

        await requireAuth();
        const currentUser = await getCurrentUser();

        const borrowGrid = document.getElementById("borrow-grid");
        const sellGrid = document.getElementById("sell-grid");
        const lendGrid = document.getElementById("lend-grid");

        function createCard(item) {
            const card = document.createElement("div");
            card.className = "item-card";

            const badge = item.mode.toUpperCase();
            const price = item.price ? `â‚¹${item.price}` : "Free";

            // Don't show Message button if it's my own item
            const isMine = currentUser && currentUser.id === item.owner_id;
            const ownerName = item.owner?.username || "User";
            const buttonHtml = isMine
                ? `<button class="submit-btn" disabled style="opacity:0.5;cursor:not-allowed">Your Item</button>`
                : `<button class="submit-btn" onclick="window.location.href='chat.html?item=${item.id}&to=${item.owner_id}&name=${encodeURIComponent(ownerName)}'">Message</button>`;

            const imageHtml = item.image_url
                ? `<img src="${item.image_url}" style="width:100%;height:100%;object-fit:cover;">`
                : `<div class="placeholder-image"></div>`;

            card.innerHTML = `
              <div class="item-badge ${item.mode}">${badge}</div>
              <div class="item-image">
                ${imageHtml}
              </div>
              <h3>${item.title}</h3>
              <p>${item.description}</p>
              <p><strong>${price}</strong></p>
              ${buttonHtml}
            `;

            return card;
        }

        async function renderItems() {
            borrowGrid.innerHTML = "";
            sellGrid.innerHTML = "";
            lendGrid.innerHTML = "";

            const items = await loadItems();

            items.forEach(item => {
                const card = createCard(item);
                if (item.mode === "sell") sellGrid.appendChild(card);
                else if (item.mode === "lend") lendGrid.appendChild(card);
                else borrowGrid.appendChild(card);
            });
        }

        await renderItems();

        const form = document.getElementById("list-item-form");
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('.submit-btn');
            submitBtn.textContent = 'Listing...';
            submitBtn.disabled = true;

            const title = document.getElementById("item-title").value;
            const description = document.getElementById("item-description").value;
            const category = document.getElementById("item-category").value;
            const price = Number(document.getElementById("item-price").value);

            const urlInput = document.getElementById("item-image-url");
            const fileInput = document.getElementById("item-image-file");

            let imageUrl = urlInput.value;
            if (fileInput.files.length > 0) {
                imageUrl = await uploadImage(fileInput.files[0]);
            }

            const activeBtn = document.querySelector(".listing-type-btn.active");
            let mode = "lend";
            if (activeBtn.dataset.listingType === "selling") mode = "sell";
            else if (activeBtn.dataset.listingType === "buying") mode = "buy";

            const item = await addItem({
                title,
                description,
                category,
                price,
                mode,
                image_url: imageUrl
            });

            submitBtn.textContent = 'List Item';
            submitBtn.disabled = false;

            if (item) {
                closeListModal();
                form.reset();
                await renderItems();
            }
        });
    </script>
</body>

</html>